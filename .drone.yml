---
kind: pipeline
name: default

steps:
- name: set version in Cargo.toml
  image: rust:slim
  commands:
  - echo "Setting Cargo.toml to version $DRONE_TAG:"
  - sed -i -e "s/99\.99\.9/$(echo $DRONE_TAG | tr -d 'v')/" Cargo.toml
  - cat Cargo.toml
  when:
    event: tag

- name: build for x86_64
  image: rust:slim
  commands:
  - apt-get update
  - apt-get install -y make
  - cargo build --release
  depends_on:
  - "set version in Cargo.toml"

- name: build for armv7l
  image: rust:slim
  commands:
  - apt-get update
  - apt-get install -y make gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
  - rustup target add armv7-unknown-linux-gnueabihf
  - cargo build --release --target armv7-unknown-linux-gnueabihf
  depends_on:
  - "set version in Cargo.toml"

- name: build for Windows
  image: rust:slim
  commands:
  - apt-get update
  - apt-get install -y gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64
  - rustup target add x86_64-pc-windows-gnu
  - cargo build --release --target x86_64-pc-windows-gnu
  depends_on:
  - "set version in Cargo.toml"

- name: prepare release
  image: rust:slim
  commands:
  - mkdir target/_release
  - cp target/release/netio                               target/_release/netio-x86_64
  - cp target/armv7-unknown-linux-gnueabihf/release/netio target/_release/netio-armv7l
  - cp target/x86_64-pc-windows-gnu/release/netio.exe     target/_release/netio.exe
  depends_on:
  - "build for x86_64"
  - "build for armv7l"
  - "build for Windows"
  when:
    event: tag

- name: publish
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github-token
    files:
      - target/_release/netio-x86_64
      - target/_release/netio-armv7l
      - target/_release/netio.exe
    checksum:
      - sha256
  depends_on:
  - "prepare release"
  when:
    event: tag
---
kind: signature
hmac: 7668e9aaf0495b4f6ea050242fb641e20cfeacc6b27cf9c92ca926aca6091e4b

...
